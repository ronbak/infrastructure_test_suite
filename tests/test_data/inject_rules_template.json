{
  "https://api.github.com/repos/Worldremit/arm_templates/contents/networks/nsgs.json": "{\n  \"$schema\": \"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json\",\n  \"contentVersion\": \"1.0.0.0\",\n  \"parameters\": {\n    \"vNetName\": {\n      \"type\": \"string\",\n      \"defaultValue\": \"vNet1\",\n      \"metadata\": {\n        \"description\": \"Name for vNet 1\"\n      }\n    },\n    \"vNet\": {\n      \"type\": \"object\"\n    },\n    \"subnets_array\": {\n      \"type\": \"array\"\n    },\n    \"environment\": {\n      \"type\": \"String\"\n    },\n    \"location\": {\n      \"type\": \"String\",\n      \"defaultValue\": \"WestEurope\"\n    },\n    \"location_tag\": {\n      \"type\": \"String\",\n      \"defaultValue\": \"eurw\"\n    }\n  },\n  \"variables\": {\n    \"inject_rules_here\": true\n  },\n  \"resources\": [\n    {\n      \"apiVersion\": \"2015-06-15\",\n      \"type\": \"Microsoft.Network/networkSecurityGroups\",\n      \"name\": \"[concat('nsg01-', parameters('subnets_array')[copyIndex()].landscape, '-', parameters('location_tag'), '-', parameters('subnets_array')[copyIndex()].name)]\",\n      \"condition\": \"[not(equals(parameters('subnets_array')[copyIndex()].name, parameters('vNet').landscapes.gateway.name))]\",\n      \"copy\": {\n        \"name\": \"nsgCopy\",\n        \"count\": \"[length(parameters('subnets_array'))]\"\n      },\n      \"location\": \"[resourceGroup().location]\",\n      \"tags\": {\n        \"displayName\": \"[concat(parameters('subnets_array')[copyIndex()].landscape, '_', parameters('subnets_array')[copyIndex()].name, '-nsg')]\"\n      },\n      \"properties\": {\n        \"securityRules\": [\n          {\n            \"name\": \"allow-core-networking-out\",\n            \"properties\": {\n              \"description\": \"Allow access to core network\",\n              \"protocol\": \"*\",\n              \"sourcePortRange\": \"*\",\n              \"destinationPortRange\": \"*\",\n              \"sourceAddressPrefix\": \"*\",\n              \"destinationAddressPrefix\": \"[parameters('vNet').landscapes.core.addressSpacePrefix]\",\n              \"access\": \"Allow\",\n              \"priority\": 100,\n              \"direction\": \"Outbound\"\n            }\n          },\n          {\n            \"name\": \"allow-gateway-out\",\n            \"properties\": {\n              \"description\": \"Allow access to gateway subnet\",\n              \"protocol\": \"*\",\n              \"sourcePortRange\": \"*\",\n              \"destinationPortRange\": \"*\",\n              \"sourceAddressPrefix\": \"*\",\n              \"destinationAddressPrefix\": \"[parameters('vNet').landscapes.gateway.addressSpacePrefix]\",\n              \"access\": \"Allow\",\n              \"priority\": 110,\n              \"direction\": \"Outbound\"\n            }\n          },\n          {\n            \"name\": \"allow-vnets-out\",\n            \"properties\": {\n              \"description\": \"Allow access to all vNets\",\n              \"protocol\": \"*\",\n              \"sourcePortRange\": \"*\",\n              \"destinationPortRange\": \"*\",\n              \"sourceAddressPrefix\": \"*\",\n              \"destinationAddressPrefix\": \"VirtualNetwork\",\n              \"access\": \"Allow\",\n              \"priority\": 4095,\n              \"direction\": \"Outbound\"\n            }\n          },\n          {\n            \"name\": \"allow-internet-out\",\n            \"properties\": {\n              \"description\": \"Allow access to internet\",\n              \"protocol\": \"*\",\n              \"sourcePortRange\": \"*\",\n              \"destinationPortRange\": \"*\",\n              \"sourceAddressPrefix\": \"*\",\n              \"destinationAddressPrefix\": \"Internet\",\n              \"access\": \"Allow\",\n              \"priority\": 4096,\n              \"direction\": \"Outbound\"\n            }\n          },\n          {\n            \"name\": \"allow-core-networking-in\",\n            \"properties\": {\n              \"description\": \"Allow core network in\",\n              \"protocol\": \"Tcp\",\n              \"sourcePortRange\": \"*\",\n              \"destinationPortRange\": \"*\",\n              \"sourceAddressPrefix\": \"[parameters('vNet').landscapes.core.addressSpacePrefix]\",\n              \"destinationAddressPrefix\": \"*\",\n              \"access\": \"Allow\",\n              \"priority\": 100,\n              \"direction\": \"Inbound\"\n            }\n          },\n          {\n            \"name\": \"allow-gateway-in\",\n            \"properties\": {\n              \"description\": \"Allow access from gateway subnet\",\n              \"protocol\": \"*\",\n              \"sourcePortRange\": \"*\",\n              \"destinationPortRange\": \"*\",\n              \"sourceAddressPrefix\": \"[parameters('vNet').landscapes.gateway.addressSpacePrefix]\",\n              \"destinationAddressPrefix\": \"*\",\n              \"access\": \"Allow\",\n              \"priority\": 110,\n              \"direction\": \"Inbound\"\n            }\n          },\n          {\n            \"name\": \"deny-dev-landscapes\",\n            \"properties\": {\n              \"description\": \"block all traffic from other dev landscapes\",\n              \"protocol\": \"*\",\n              \"sourcePortRange\": \"*\",\n              \"destinationPortRange\": \"*\",\n              \"sourceAddressPrefix\": \"[parameters('vNet').addressSpacePrefix]\",\n              \"destinationAddressPrefix\": \"*\",\n              \"access\": \"Deny\",\n              \"priority\": 4096,\n              \"direction\": \"Inbound\"\n            }\n          }\n        ]\n      }\n    },\n    {\n      \"apiVersion\": \"2016-09-01\",\n      \"type\": \"Microsoft.Network/networkSecurityGroups/securityRules\",\n      \"name\": \"nsg01-dev-eurw-private/sql-from-privpartner\",\n      \"location\": \"\",\n      \"properties\": {\n        \"description\": \"Rule to allow SQL in to private subnet from privatepartner to dev\",\n        \"protocol\": \"Tcp\",\n        \"sourcePortRange\": \"*\",\n        \"destinationPortRange\": \"1433\",\n        \"sourceAddressPrefix\": \"213.57.32.1/32\",\n        \"destinationAddressPrefix\": \"10.24.16.0/23\",\n        \"access\": \"Allow\",\n        \"priority\": 200,\n        \"direction\": \"Inbound\"\n      },\n      \"dependsOn\": [\n        \"Microsoft.Network/networkSecurityGroups/nsg01-dev-eurw-private\"\n      ]\n    },\n    {\n      \"apiVersion\": \"2016-09-01\",\n      \"type\": \"Microsoft.Network/networkSecurityGroups/securityRules\",\n      \"name\": \"nsg01-tst-eurw-private/sql-from-privpartner\",\n      \"location\": \"\",\n      \"properties\": {\n        \"description\": \"Rule to allow SQL in to private subnet from privatepartner to tst\",\n        \"protocol\": \"Tcp\",\n        \"sourcePortRange\": \"*\",\n        \"destinationPortRange\": \"1433\",\n        \"sourceAddressPrefix\": \"213.57.32.1/32\",\n        \"destinationAddressPrefix\": \"10.24.32.0/23\",\n        \"access\": \"Allow\",\n        \"priority\": 200,\n        \"direction\": \"Inbound\"\n      },\n      \"dependsOn\": [\n        \"Microsoft.Network/networkSecurityGroups/nsg01-tst-eurw-private\"\n      ]\n    },\n    {\n      \"apiVersion\": \"2016-09-01\",\n      \"type\": \"Microsoft.Network/networkSecurityGroups/securityRules\",\n      \"name\": \"nsg01-dev-eurw-publicclient/sql-to-pub-cli\",\n      \"location\": \"\",\n      \"properties\": {\n        \"description\": \"Rule to allow SQL in to public-client subnet from private to dev\",\n        \"protocol\": \"Tcp\",\n        \"sourcePortRange\": \"*\",\n        \"destinationPortRange\": \"1433\",\n        \"sourceAddressPrefix\": \"10.24.18.0/23\",\n        \"destinationAddressPrefix\": \"10.24.20.0/23\",\n        \"access\": \"Allow\",\n        \"priority\": 200,\n        \"direction\": \"Inbound\"\n      },\n      \"dependsOn\": [\n        \"Microsoft.Network/networkSecurityGroups/nsg01-dev-eurw-publicclient\"\n      ]\n    },\n    {\n      \"apiVersion\": \"2016-09-01\",\n      \"type\": \"Microsoft.Network/networkSecurityGroups/securityRules\",\n      \"name\": \"nsg01-tst-eurw-publicclient/sql-to-pub-cli\",\n      \"location\": \"\",\n      \"properties\": {\n        \"description\": \"Rule to allow SQL in to public-client subnet from private to tst\",\n        \"protocol\": \"Tcp\",\n        \"sourcePortRange\": \"*\",\n        \"destinationPortRange\": \"1433\",\n        \"sourceAddressPrefix\": \"10.24.34.0/23\",\n        \"destinationAddressPrefix\": \"10.24.36.0/23\",\n        \"access\": \"Allow\",\n        \"priority\": 200,\n        \"direction\": \"Inbound\"\n      },\n      \"dependsOn\": [\n        \"Microsoft.Network/networkSecurityGroups/nsg01-tst-eurw-publicclient\"\n      ]\n    }\n  ]\n}"
}